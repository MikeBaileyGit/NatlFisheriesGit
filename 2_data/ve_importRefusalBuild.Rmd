---
title: "Import Rejection Consolidation of FDA and USDA data"
author: "Vince Egalla"
date: "11/24/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Dependencies

```{r}
library(tidyverse)
library(readxl)
library(plyr)
library(dplyr)
library(countrycode)
library(lubridate)
library(ggplot2)
#library(extrafont)
#font_import()
#library(tabulizer)
```

## Load Data

```{r}
## FDA
fda = read_csv("raw/FDA/Import_Refusal_2014-present/REFUSAL_ENTRY_2014-September2020.CSV")
```

```{r}
## FDA - catfish refusal weight
kg = read_csv("raw/ITACS/FDA_ENTRY_NUM_REVIEW.CSV")
```

```{r}
## USDA - Archived
usdaArchived = read_excel("raw/USDA/import-refusals-archived.xlsx", skip= 2)
```

```{r}
## USDA - Current
usdaCurrent = read_excel("raw/USDA/import-refusals-current.xlsx", skip= 2)
```

```{r}
fsis = read_csv("output/build/fsisSiluriformesWords.csv")
```

## Combine FDA and FDA Weight
```{r}
## Get list of column names to merge by
fda_col = colnames(fda)

## Dates need to be standardized because the review of ITACS ended up losing leading 0 in "REFUSAL DATE"
fda$REFUSAL_DATE = as.Date(fda$REFUSAL_DATE, format= '%d-%b-%y')

kg$REFUSAL_DATE = as.Date(kg$REFUSAL_DATE, format= '%d-%b-%y')

## Merge weight data
fda = merge(fda, kg, by= fda_col, all.x= TRUE)

## Check count of non-missing weight data
# 52 observations exist for Catfish, but one record related to Nigeria (NG) could not be found in ITACS
fda[(!is.na(fda$Weight_Refused_KG)),]

```




## Combine USDA data

```{r}
## Vertical join of USDA Archived & Current
usda = rbind(usdaCurrent, usdaArchived)
```

```{r}
## Check for duplicates after row bind of Archived & Current
usda[duplicated(usda),]
```

```{r}
## Check column names
colnames(usda)

## Update column names to remove spacing/breaks
names(usda)[names(usda) == "AppLot\r\nNumber"] = "app_lot_number"
names(usda)[names(usda) == "Country"] = "country"
names(usda)[names(usda) == "Received\r\nLot Date"] = "received_lot_date"
names(usda)[names(usda) == "Export\r\nEstablishment"] = "export_establishment"
names(usda)[names(usda) == "Company\r\nName"] = "company_name"
names(usda)[names(usda) == "HACCP\r\nCode"] = "HACCP_code"
names(usda)[names(usda) == "Product\r\nCategory"] = "product_category"
names(usda)[names(usda) == "Species\r\nName"] = "species_name"
names(usda)[names(usda) == "Final Weight\r\nRefused"] = "final_weight_refused"
names(usda)[names(usda) == "Refusal\r\nReasons"] = "refusal_reasons"
names(usda)[names(usda) == "Failed TOI"] = "failed_TOI"
names(usda)[names(usda) == "Defect\r\nDescriptions"] = "defect_desc"
```

```{r}
## Check updated names
colnames(usda)
```

## Flag catfish/pangasius records in both

```{r}
## FDA Product Description Frequency Table
fda$PRDCT_CODE_DESC_TEXT = tolower(fda$PRDCT_CODE_DESC_TEXT)

## FDA Product Description Frequency Table
fdaProducts = as.data.frame(table(fda$PRDCT_CODE_DESC_TEXT))
```

```{r}
## Check product categories given keyword searches
fdaCatfish = fdaProducts[grepl("catfish", fdaProducts$Var1),]
```

```{r}
## Check product categories given keyword searches / expand this search to use all common names of siluriformes according to FSIS
fdaProducts[grepl("pangasius", fdaProducts$Var1),]
```

```{r}
## Check product categories given keyword searches / expand this search to use all common names of siluriformes according to FSIS
fdaProducts[grepl("siluriformes", fdaProducts$Var1),]
```

```{r}
## Create catfish dummy for FDA data
fda = mutate(fda, catfish = ifelse(fda$PRDCT_CODE_DESC_TEXT %in% fdaCatfish$Var1, 1, 0))

## Check records flagged with catfish dummy
fda[fda$catfish == 1,]
```

```{r}
## Create flag for catfish records related to food safety refusal
pattern2 = "2860|238|249|83|2000|3821|280|308"

fda = mutate(fda, catfish_food_refusal= ifelse(catfish == 1,ifelse(grepl(pattern2, fda$REFUSAL_CHARGES), 1, 0), 0))

## Check records flagged with catfish dummy
fda[fda$catfish == 1,]

```

```{r}
## Create flag for Product Descriptions that contains words from the FSIS document
fsis.words = as.vector(fsis$word)
pattern = paste(fsis.words, collapse="|")

## Create catfish dummy for FDA data
fda = mutate(fda, fsis= ifelse(grepl(pattern, fda$PRDCT_CODE_DESC_TEXT), 1, 0))

## Check records flagged with catfish dummy
fda[fda$fsis == 1,]
```


```{r}
## USDA Species Category Description Frequency Table
usdaProducts = as.data.frame(table(usda$species_name))
```

```{r}
## Check product categories given keyword searches
usdaCatfish = usdaProducts[grepl("Siluriformes", usdaProducts$Var1),]
```

```{r}
## Create catfish dummy for USDA data
usda = mutate(usda, catfish = ifelse(usda$species_name %in% usdaCatfish$Var1, 1, 0))

## Check records flagged with catfish dummy
usda[usda$catfish == 1,]
```

```{r}
## Create flag for catfish records related to food safety refusal

usda = mutate(usda, catfish_food_refusal= ifelse(catfish == 1,ifelse(grepl("Failed Laboratory Analyses", usda$refusal_reasons), 1, 0), 0))

## Check records flagged with catfish dummy
usda[usda$catfish == 1,]

```

## Standardize date between FDA and USDA

```{r}
## Create date variable
fda$date = fda$REFUSAL_DATE
```

```{r}
## Check date data type
typeof(usda$received_lot_date)

## Convert to numeric
usda$date = as.Date(usda$received_lot_date, '%Y-%m-%d')
```

## Standardize country between FDA and USDA

```{r}
## Convert ISO Country Code to Long Name
# Ambiguous values are not relevant and may be ignored.
fda$country_std = toupper(countrycode(fda$ISO_CNTRY_CODE, origin= 'iso2c', destination= 'country.name'))
```

```{r}
## Convert ISO Country Code to Long Name
# Ambiguous values are not relevant and may be ignored.
usda$country_iso = toupper(countrycode(usda$country, origin= 'country.name', destination= 'iso2c'))

usda$country_std = toupper(countrycode(usda$country_iso, origin= 'iso2c', destination= 'country.name'))
```

## Standardize refused item weight to kg and a single variable
```{r}
## Create standardized variable
fda$refusal_weight = ifelse(fda$catfish == 1, fda$Weight_Refused_KG, 0)
```

```{r}
## Create standardized variable; convert lbs to kg
usda$refusal_weight = ifelse(usda$catfish == 1, usda$final_weight_refused / 2.205, 0)
```


## Pre-Merge: Add source and limit to relevant variables

```{r}
## Add data sources
fda$source = "FDA"
usda$source = "USDA"
```

## Merge of FDA and USDA data (limited to catfish flag, date, exporting country, and source-specific identifiers of product, company, and entry

```{r}
## Stack data subsets
composite = rbind.fill(fda, usda)

composite
```
## Check on merged values
```{r}
compositeCountries = distinct(composite, country_std)
```

## Export

```{r}
## Export as RData
save(composite, file="output/build/compositeImportRefusal.RData")
```

```{r}
## Export as CSV
write.csv(composite, file="output/build/compositeImportRefusal.CSV")
```

